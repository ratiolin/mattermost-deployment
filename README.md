# Mattermost 单机部署（Docker + Nginx + HTTPS）

本仓库记录了一次 **在云服务器上部署 Mattermost 并成功对公网提供 HTTPS 服务** 的完整过程。  
目标是实现一个 **真实可运行、可复现、具备基础运维边界意识的单机系统**。

---

## 一、目标系统形态

最终系统结构如下：

Internet  
→ DNS（chat.metratio.com）  
→ HTTPS  
→ Nginx（Docker，反向代理）  
→ Mattermost（Docker）  
→ PostgreSQL 14（Docker）

关键特征：

- 全链路 HTTPS
- 应用、数据、入口分层
- 仅入口层对公网暴露
- 数据通过 Volume 持久化
- 不依赖宿主机直接运行应用进程

---

## 二、部署前提条件

部署环境满足以下条件：

- 一台可公网访问的云服务器
- Linux 发行版（systemd 管理服务）
- 具备 root 初始访问权限
- 已准备域名并可修改 DNS 解析
- 服务器 80 / 443 端口可达

---

## 三、服务器基础准备

在任何服务部署之前，首先完成以下基础工作：

- 确认系统类型、内核版本、服务管理方式
- 建立非 root 的长期运维用户
- 配置 sudo 权限
- 启用 SSH Key 登录
- 禁用 root 直连与密码登录

该阶段目标是：

> 明确责任用户、权限边界与长期可维护性  
> 而不是尽快安装软件

---

## 四、Docker 运行环境

Docker 在本系统中作为 **基础设施层** 使用，负责：

- 进程隔离
- 生命周期管理
- 资源与网络边界

需要完成的准备包括：

- 安装 Docker Engine
- 确认 daemon 正常运行
- 配置国内镜像加速（避免拉取失败）
- 理解 docker.sock 的权限等价性
- 明确容器无状态、Volume 有状态的语义差异

Docker 本身不承载业务逻辑，仅作为系统运行时。

---

## 五、服务编排与系统拓扑

系统通过 Docker Compose 定义服务拓扑。

服务划分为三层：

- 数据层：PostgreSQL
- 应用层：Mattermost
- 入口层：Nginx

设计原则：

- 服务名作为内部 DNS 名称
- 数据库与应用不暴露宿主机端口
- 仅入口层映射 80 / 443
- 服务通过内部网络通信
- 数据通过 Volume 脱离容器生命周期

Compose 文件在此处承担的是 **系统结构描述**，而非简单启动脚本。

---

## 六、数据库约束与数据安全

PostgreSQL 作为状态组件，需明确以下约束：

- 数据目录通过 Volume 持久化
- 数据一旦写入，不可随意销毁
- 数据库版本升级不可逆

数据库相关问题优先从：

- Volume 挂载
- 权限与 UID 映射
- 服务启动顺序

等角度排查，而非直接重建容器。

---

## 七、入口层与反向代理

Nginx 在系统中承担 **唯一入口角色**：

- 接收公网请求
- 建立 HTTPS 信任
- 转发请求至内部应用

核心特性：

- 仅通过 Docker 内部 DNS 定位上游服务
- 不依赖固定 IP
- 启动即校验配置与证书有效性
- 配置错误会导致容器直接退出

入口层配置遵循原则：

> 稳定优先、修改可回滚、行为可解释

---

## 八、HTTPS 与证书处理

HTTPS 是系统对外可用的必要条件。

证书申请流程包括：

- 域名正确解析至服务器 IP
- 80 端口可用于 CA 校验
- 使用 Certbot 独立申请证书

证书管理需注意：

- Let’s Encrypt 目录中大量使用软链接
- Docker 容器内必须使用“真实文件”
- 复制证书时需解析软链接目标
- 权限与路径错误会导致 Nginx 启动失败

证书申请成功 ≠ HTTPS 可用  
必须确保证书被正确挂载并被 Nginx 使用。

---

## 九、启动顺序与运行验证

推荐启动顺序：

1. Docker 服务
2. 数据库容器
3. Mattermost 容器
4. Nginx 容器

验证点包括：

- 容器状态是否正常
- 内部服务名是否可解析
- Nginx 配置是否通过语法检查
- HTTPS 访问是否建立成功
- 数据是否在容器重启后仍然存在